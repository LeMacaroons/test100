- name: Check if service exists
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
  register: service_status
  failed_when: false
  changed_when: false

- name: Stop service if it exists and is running
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
    state: stopped
  when: 
    - service_status.status is defined
    - service_status.status.LoadState == "loaded"
  register: stop_result
  failed_when: false

- name: Wait for service to fully stop
  ansible.builtin.wait_for:
    timeout: 30
  delegate_to: localhost
  when: stop_result is changed

- name: Verify service is stopped
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
  register: verify_stop
  until: verify_stop.status.ActiveState in ['inactive', 'failed']
  retries: 6
  delay: 10
  when: service_status.status is defined
  failed_when: false

- name: Pause after stop
  pause:
    seconds: 60



- name: Check service status before starting
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
  register: service_status
  failed_when: false
  changed_when: false

- name: Start service
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
    state: started
    daemon_reload: yes
  register: start_result
  when: 
    - service_status.status is defined
    - service_status.status.LoadState == "loaded"

- name: Wait for service to be active
  ansible.builtin.systemd:
    name: "{{ service_name }}.service"
  register: verify_start
  until: verify_start.status.ActiveState == 'active'
  retries: 6
  delay: 10
  when: start_result is changed

- name: Pause after start
  pause:
    seconds: 60
